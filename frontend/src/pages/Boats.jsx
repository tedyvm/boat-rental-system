import { useEffect, useState } from "react";
import { useLocation } from "react-router-dom";
import BoatFilters from "../components/BoatFilters";
import SearchBar from "../components/SearchBar";
import "../styles/Boats.css";
import Button from "react-bootstrap/Button";
import Offcanvas from "react-bootstrap/Offcanvas";

export default function Boats() {
  const location = useLocation();
  const [boats, setBoats] = useState([]);
  const [loading, setLoading] = useState(true);

  const [show, setShow] = useState(false);
  const handleClose = () => setShow(false);
  const handleShow = () => setShow(true);

  const handleFiltersChange = (filters) => {
    const params = new URLSearchParams(filters).toString();
    window.history.replaceState({}, "", `/boats?${params}`);
    window.dispatchEvent(new PopStateEvent("popstate"));
  };

  useEffect(() => {
    const fetchBoats = async () => {
      try {
        setLoading(true);
        const res = await fetch(
          `http://localhost:5000/api/boats/search${location.search}`
        );
        if (!res.ok) throw new Error("Nepavyko gauti laivų sąrašo");
        const data = await res.json();
        setBoats(data);
      } catch (err) {
        console.error(err);
      } finally {
        setLoading(false);
      }
    };

    fetchBoats();
  }, [location.search]);

  return (
    <div>
      <div className="container-fluid boats-s1"></div>

      {/* Mobilus mygtukas – iškeltas virš search bar */}
      <div className="boats-filter-button-wrapper d-block d-md-none text-end">
        <Button variant="primary" onClick={handleShow} className="button">
          Filters
        </Button>

        <Offcanvas show={show} onHide={handleClose} placement="end" className="boats-offcanvas" >
          <Offcanvas.Header closeButton>
            <Offcanvas.Title>Filters</Offcanvas.Title>
          </Offcanvas.Header>
          <Offcanvas.Body>
            <BoatFilters
              onChange={handleFiltersChange}
              initialValues={Object.fromEntries(
                new URLSearchParams(location.search).entries()
              )}
            />
          </Offcanvas.Body>
        </Offcanvas>
      </div>

      {/* SearchBaras (desktop) */}
      <div className="container-fluid search-bar d-none d-md-block">
        <div className="container ">
          <SearchBar showButton={false} onFiltersChange={handleFiltersChange} />
        </div>
      </div>

      <div className="row mt-4">
        {/* Filtrai kairej */}
        <aside className="col-md-3 d-none d-md-block">
          <BoatFilters
            onChange={handleFiltersChange}
            initialValues={Object.fromEntries(
              new URLSearchParams(location.search).entries()
            )}
          />
        </aside>

        {/* Laivų sąrašas */}
        <section className="col-md-9">
          {loading && <p>Loading...</p>}
          {!loading && boats.length === 0 && (
            <p>
              Sorry, no boats found. Please try to change your search criteria.
            </p>
          )}
          <div className="row">
            {boats.map((boat) => (
              <div key={boat._id} className="col-md-6 col-lg-4 mb-4">
                <div className="card h-100 shadow-sm">
                  {boat.images?.[0] && (
                    <img
                      src={boat.images[0]}
                      className="card-img-top"
                      alt={boat.name}
                      style={{ height: "200px", objectFit: "cover" }}
                    />
                  )}
                  <div className="card-body d-flex flex-column">
                    <h5 className="card-title">{boat.name}</h5>
                    <p className="card-text">{boat.type}</p>
                    <p className="card-text">
                      <svg
                        width="25"
                        height="25"
                        viewBox="0 0 25 25"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <g clip-path="url(#clip0_757_1932)">
                          <path
                            d="M6.29951 4.39516C5.08569 4.39556 4.10195 3.41177 4.10156 2.19795C4.10156 0.984131 5.0853 0.000390741 6.29873 1.16292e-07C7.51216 -0.000390509 8.49629 0.98335 8.49668 2.19717V2.19756C8.49551 3.4106 7.51255 4.39355 6.29951 4.39516ZM6.29951 0.394629C5.30391 0.394238 4.49653 1.20161 4.49614 2.19722C4.49575 3.19282 5.30312 4.00019 6.29873 4.00059C7.29434 4.00098 8.10171 3.1936 8.1021 2.198C8.1021 2.19761 8.1021 2.19761 8.1021 2.19722C8.10093 1.20239 7.29473 0.395801 6.29951 0.394629Z"
                            fill="black"
                          />
                          <path
                            d="M7.64987 25C6.96721 24.9992 6.41438 24.4464 6.41355 23.7637V15.4414H6.18586V23.7637C6.18586 24.4464 5.63264 24.9996 4.94997 24.9996C4.26731 24.9996 3.71409 24.4464 3.71409 23.7637V8.62892H3.48523V13.455C3.48523 14.1377 2.93161 14.6913 2.2489 14.6913C1.56619 14.6913 1.01257 14.1377 1.01257 13.455V7.85348C1.01453 6.16774 2.38069 4.80157 4.06643 4.79962H8.53259C10.2179 4.8024 11.5841 6.16813 11.5872 7.85348V13.4542C11.5872 14.1368 11.034 14.6901 10.3513 14.6901C9.66867 14.6901 9.11545 14.1368 9.11545 13.4542V8.6277H8.8862V23.7637C8.88503 24.446 8.33215 24.9988 7.64987 25ZM5.79128 15.0468H6.80896V23.7637C6.80896 24.2285 7.18581 24.605 7.65026 24.605C8.11472 24.605 8.49157 24.2281 8.49157 23.7637V8.23312H9.51008V13.4538C9.51008 13.9186 9.88693 14.2951 10.3514 14.2951C10.8158 14.2951 11.1927 13.9182 11.1927 13.4538V7.85348C11.1895 6.38595 10.0002 5.19699 8.53264 5.1942H4.06565C2.59773 5.19576 1.40798 6.38551 1.40637 7.85348V13.4549C1.40637 13.9198 1.78323 14.2966 2.24807 14.2966C2.71291 14.2966 3.08977 13.9198 3.08977 13.4549V8.2339H4.10783V23.7633C4.10783 24.2278 4.4843 24.6046 4.94914 24.6046C5.41399 24.6046 5.79045 24.2281 5.79045 23.7633L5.79128 15.0468Z"
                            fill="black"
                          />
                          <path
                            d="M18.6988 4.39524C17.485 4.39563 16.5012 3.41189 16.5009 2.19807C16.5009 0.984253 17.4846 0.000512812 18.698 0.000122187C19.9118 -0.000268438 20.8956 0.983472 20.896 2.19729V2.19768C20.8948 3.41067 19.9118 4.39363 18.6988 4.39524ZM18.6988 0.394702C17.7032 0.394312 16.8958 1.20168 16.8954 2.19729C16.895 3.1929 17.7024 4.00027 18.698 4.00066C19.6936 4.00105 20.501 3.19368 20.5014 2.19807C20.5014 2.19768 20.5014 2.19768 20.5014 2.19729C20.5002 1.20247 19.694 0.395874 18.6988 0.394702Z"
                            fill="black"
                          />
                          <path
                            d="M20.0492 25C19.367 24.9992 18.8141 24.4459 18.8134 23.7636V15.4414H18.5853V23.7636C18.5853 24.4463 18.0321 24.9995 17.3494 24.9995C16.6667 24.9995 16.1135 24.4463 16.1135 23.7636V8.62886H15.8843V13.4549C15.8843 14.1376 15.331 14.6908 14.6484 14.6908C13.9657 14.6908 13.4125 14.1376 13.4125 13.4549V7.85342C13.4144 6.16768 14.7806 4.80151 16.4663 4.79956H20.9329C22.6182 4.80234 23.9844 6.16807 23.9875 7.85342V13.4541C23.9879 14.1368 23.4347 14.6908 22.752 14.6912C22.0694 14.6916 21.5153 14.1384 21.5149 13.4557C21.5149 13.4553 21.5149 13.4549 21.5149 13.4545V8.62769H21.2861V23.7636C21.2847 24.4459 20.7319 24.9992 20.0492 25ZM18.1902 15.0467H19.2079V23.7636C19.2083 24.2285 19.5851 24.6049 20.05 24.6049C20.5144 24.6045 20.8909 24.2281 20.8913 23.7636V8.23306H21.9093V13.4537C21.909 13.9186 22.2858 14.2958 22.7507 14.2958C23.2155 14.2958 23.5927 13.9193 23.5927 13.4545C23.5927 13.4541 23.5927 13.4537 23.5927 13.4533V7.85342C23.5896 6.38589 22.4003 5.19692 20.9327 5.19414H16.4661C14.9982 5.1957 13.8085 6.38545 13.8069 7.85342V13.4549C13.8069 13.9197 14.1837 14.2962 14.6482 14.2962C15.1126 14.2962 15.4895 13.9193 15.4895 13.4549V8.23384H16.508V23.7632C16.508 24.2281 16.8848 24.6045 17.3493 24.6045C17.8137 24.6045 18.1906 24.2277 18.1906 23.7632L18.1902 15.0467Z"
                            fill="black"
                          />
                        </g>
                        <defs>
                          <clipPath id="clip0_757_1932">
                            <rect width="25" height="25" fill="white" />
                          </clipPath>
                        </defs>
                      </svg>{" "}
                      x {boat.capacity}{" "}
                      <svg
                        width="25"
                        height="25"
                        viewBox="0 0 25 25"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          d="M0.858561 16.038H24.115V15.0879C24.115 14.858 24.0702 14.6443 23.9909 14.4531C23.9054 14.2497 23.7793 14.0686 23.6226 13.9119C23.527 13.8163 23.4192 13.7288 23.3032 13.6515C23.1852 13.5722 23.0591 13.503 22.9268 13.444C22.5708 13.3667 22.2168 13.2934 21.8648 13.2243C21.5108 13.1551 21.1548 13.09 20.7967 13.029C20.7804 13.0269 20.7682 13.0249 20.752 13.0208C20.5709 12.9903 20.3979 12.9618 20.2332 12.9354C20.0684 12.9089 19.8934 12.8825 19.7103 12.854H19.7062C18.4611 12.6953 17.2201 12.5732 15.981 12.4918C14.74 12.4105 13.505 12.3698 12.2782 12.3677C11.5499 12.3677 10.8236 12.3799 10.0972 12.4084C9.375 12.4369 8.64868 12.4776 7.92236 12.5346H7.91829C7.23877 12.5976 6.56128 12.677 5.88175 12.7685C5.20426 12.8601 4.52474 12.9679 3.84115 13.088L3.76587 13.1063C3.75163 13.1103 3.73739 13.1124 3.72518 13.1124C3.71297 13.1144 3.70076 13.1144 3.68856 13.1144C3.36914 13.1714 3.04159 13.2344 2.70386 13.3016C2.3763 13.3667 2.04875 13.4359 1.72323 13.5071C1.64185 13.5518 1.56453 13.6027 1.49129 13.6556C1.41805 13.7105 1.34684 13.7695 1.28377 13.8326C1.14746 13.9689 1.03963 14.1255 0.96639 14.3005C0.897217 14.4653 0.858561 14.6484 0.858561 14.8478V16.038ZM2.889 2.33356H21.8079C22.054 2.33356 22.29 2.38239 22.5057 2.4719C22.7295 2.56549 22.9309 2.7018 23.0998 2.86863C23.2686 3.0375 23.4049 3.23891 23.4965 3.46271C23.586 3.67837 23.6348 3.91437 23.6348 4.16054V12.8458C23.7386 12.9069 23.8403 12.974 23.9339 13.0473C24.0397 13.1286 24.1394 13.2141 24.231 13.3056C24.467 13.5416 24.6582 13.8163 24.7864 14.1255C24.9084 14.4165 24.9756 14.74 24.9756 15.0899V16.3289C24.9817 16.3493 24.9878 16.3696 24.9919 16.39V16.394C24.9959 16.4205 24.998 16.4449 24.998 16.4693C24.998 16.4957 24.9959 16.5222 24.9898 16.5486C24.9858 16.569 24.9797 16.5893 24.9736 16.6097V22.2371C24.9736 22.3551 24.9247 22.463 24.8474 22.5403C24.7701 22.6176 24.6623 22.6664 24.5443 22.6664H23.6593C23.5596 22.6664 23.468 22.6318 23.3948 22.5748C23.3215 22.5179 23.2666 22.4365 23.2442 22.3429C23.0815 21.875 22.9167 21.5047 22.7397 21.2158C22.5647 20.931 22.3775 20.7275 22.1619 20.5831C21.9442 20.4386 21.6838 20.3471 21.3684 20.2921C21.047 20.2352 20.6726 20.2169 20.2271 20.2189L3.99984 20.2392H3.9917C3.67228 20.2331 3.40983 20.2738 3.1901 20.3593C2.97241 20.4447 2.79541 20.5729 2.64893 20.7377C2.48413 20.9208 2.34578 21.1548 2.21965 21.4274C2.09147 21.7061 1.9755 22.0235 1.85954 22.3714C1.83105 22.4609 1.77409 22.5321 1.70288 22.583C1.63574 22.6318 1.55436 22.6603 1.47095 22.6644C1.46484 22.6664 1.45874 22.6664 1.45264 22.6664H0.429281C0.311279 22.6664 0.203451 22.6176 0.126139 22.5403C0.0488281 22.463 0 22.3551 0 22.2371V14.8498C0 14.5304 0.0610351 14.2374 0.170898 13.973C0.2889 13.6922 0.461833 13.442 0.67749 13.2263C0.738525 13.1653 0.805664 13.1042 0.876872 13.0473C0.937907 12.9984 0.998942 12.9516 1.06405 12.9089V4.14223C1.06405 3.89606 1.11287 3.66209 1.20239 3.4505C1.29598 3.22874 1.43229 3.02936 1.60116 2.86253C1.77002 2.6957 1.97144 2.56346 2.1932 2.4719C2.40885 2.38239 2.64282 2.33356 2.889 2.33356ZM21.8079 3.19212H2.889C2.75675 3.19212 2.63061 3.21857 2.51465 3.26536C2.39461 3.31419 2.28882 3.3854 2.1993 3.47288C2.11182 3.55833 2.04061 3.66412 1.99178 3.77806C1.94702 3.88995 1.92261 4.01202 1.92261 4.14223V12.4959C1.98364 12.4756 2.04468 12.4593 2.10775 12.443C2.20744 12.4166 2.30713 12.3942 2.40682 12.3779C2.54517 12.3535 2.69572 12.327 2.85848 12.2986C2.98055 12.2782 3.11076 12.2558 3.24504 12.2355V10.1033C3.24504 9.78188 3.31014 9.47467 3.42611 9.19391C3.54818 8.90094 3.72518 8.63849 3.94491 8.41876C4.16463 8.19904 4.42708 8.02203 4.72005 7.89996C5.00081 7.784 5.30802 7.71889 5.62948 7.71889H9.66187C9.98332 7.71889 10.2905 7.784 10.5713 7.89996C10.8643 8.02203 11.1267 8.19904 11.3464 8.41876C11.5662 8.63849 11.7432 8.90094 11.8652 9.19391C11.9812 9.47467 12.0463 9.78188 12.0463 10.1033V11.4644C12.1887 11.4624 12.3311 11.4624 12.4756 11.4624V10.1033C12.4756 9.78188 12.5407 9.47467 12.6567 9.19391C12.7787 8.90094 12.9557 8.63849 13.1755 8.41876C13.3952 8.19904 13.6576 8.02203 13.9506 7.89996C14.2314 7.784 14.5386 7.71889 14.86 7.71889H18.8924C19.2139 7.71889 19.5211 7.784 19.8018 7.89996C20.0948 8.02203 20.3573 8.19904 20.577 8.41876C20.7967 8.63849 20.9737 8.90094 21.0958 9.19391C21.2118 9.47467 21.2769 9.78188 21.2769 10.1033V12.207C21.4294 12.2294 21.5922 12.2558 21.7672 12.2843C21.9604 12.3148 22.1456 12.3454 22.3246 12.3759C22.4162 12.3922 22.5098 12.4105 22.6034 12.4328C22.6624 12.4471 22.7193 12.4613 22.7743 12.4776V4.16054C22.7743 4.03033 22.7478 3.90623 22.701 3.7923C22.6522 3.6743 22.5789 3.5685 22.4894 3.47695C22.3999 3.38743 22.2921 3.31419 22.1761 3.26536C22.0622 3.21857 21.9381 3.19212 21.8079 3.19212ZM8.7911 11.6028C9.20003 11.5722 9.611 11.5458 10.0281 11.5255C10.4126 11.5051 10.8012 11.4909 11.1898 11.4807V10.1033C11.1898 9.89785 11.1491 9.7005 11.0738 9.52146C10.9965 9.33429 10.8826 9.16746 10.7402 9.02504C10.5998 8.88466 10.4309 8.77073 10.2437 8.69139C10.0647 8.61611 9.86735 8.57542 9.66187 8.57542H5.62948C5.42399 8.57542 5.22664 8.61611 5.04761 8.69139C4.86043 8.7687 4.6936 8.88263 4.55119 9.02504C4.41081 9.16543 4.29688 9.33429 4.21753 9.52146C4.14225 9.7005 4.10156 9.89785 4.10156 10.1033V12.0992C4.43115 12.0504 4.76481 12.0056 5.10661 11.9608C5.47485 11.914 5.84106 11.8713 6.20321 11.8306C6.34359 11.8144 6.49414 11.796 6.6508 11.7798C6.79728 11.7635 6.94987 11.7492 7.11263 11.733C7.38932 11.7065 7.66398 11.6821 7.93457 11.6597C8.2133 11.6414 8.49813 11.6211 8.7911 11.6028ZM13.3341 11.4685C13.5803 11.4726 13.8265 11.4787 14.0727 11.4868C14.3453 11.4949 14.6179 11.5071 14.8885 11.5193H14.8905C15.3361 11.5356 15.7715 11.556 16.1947 11.5804C16.6178 11.6048 17.0308 11.6353 17.4255 11.6699C17.9993 11.7208 18.5547 11.7818 19.0816 11.853C19.5536 11.9181 20.0012 11.9914 20.4203 12.0727V10.1033C20.4203 9.89785 20.3796 9.7005 20.3044 9.52146C20.2271 9.33429 20.1131 9.16746 19.9707 9.02504C19.8303 8.88466 19.6615 8.77073 19.4743 8.69139C19.2952 8.61611 19.0979 8.57542 18.8924 8.57542H14.8621C14.6566 8.57542 14.4592 8.61611 14.2802 8.69139C14.093 8.7687 13.9262 8.88263 13.7838 9.02504C13.6434 9.16543 13.5295 9.33429 13.4501 9.52146C13.3748 9.7005 13.3341 9.89785 13.3341 10.1033V11.4685ZM24.117 16.8986H0.858561V21.8078H1.1495C1.26343 21.4864 1.38143 21.1873 1.51367 20.9208C1.65609 20.636 1.81681 20.3837 2.01213 20.166C2.24406 19.9056 2.51668 19.7042 2.84424 19.5699C3.17179 19.4376 3.55428 19.3705 4.01408 19.3807L20.2271 19.3603C20.7499 19.3603 21.1975 19.3847 21.5881 19.46C21.9849 19.5353 22.3267 19.6635 22.6339 19.8669C22.9187 20.0561 23.1628 20.3064 23.3826 20.6339C23.5921 20.9472 23.7793 21.3318 23.9583 21.8058H24.113V16.8986H24.117Z"
                          fill="black"
                          fill-opacity="0.66"
                        />
                      </svg>{" "}
                      x {boat.cabins}
                    </p>
                    <p className="fw-bold">{boat.pricePerDay} €/day</p>
                    <a
                      href={`/boats/${boat._id}`}
                      className="btn btn-primary mt-auto"
                    >
                      Details
                    </a>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </section>
      </div>
    </div>
  );
}
